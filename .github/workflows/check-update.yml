name: Check for New VLCKit Versions

on:
  schedule:
    # Run daily at 08:00 UTC
    - cron: '0 8 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  check-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Check for new stable versions
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîç Fetching VLCKit upstream tags..."
          UPSTREAM_TAGS=$(curl -sfL "https://api.github.com/repos/videolan/vlckit/tags?per_page=100" \
            | grep '"name"' \
            | sed 's/.*"name": "//;s/".*//' \
            | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' \
            | sort -V)

          echo "üìã Upstream stable versions:"
          echo "$UPSTREAM_TAGS"

          echo ""
          echo "üè∑Ô∏è  Our existing tags:"
          OUR_TAGS=$(git tag -l | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' | sort -V)
          echo "$OUR_TAGS"

          echo ""
          BASE_URL="https://download.videolan.org/pub/cocoapods/prod/"
          DIR_LISTING=$(curl -sfL "$BASE_URL")

          NEW_VERSIONS=""
          for VERSION in $UPSTREAM_TAGS; do
            if echo "$OUR_TAGS" | grep -qx "$VERSION"; then
              continue
            fi

            # Verify binaries exist on VideoLAN download page
            IOS_EXISTS=$(echo "$DIR_LISTING" | grep -c "MobileVLCKit-${VERSION}-" || true)
            # Find VLCKit but exclude MobileVLCKit and TVVLCKit
            MACOS_EXISTS=$(echo "$DIR_LISTING" | grep "VLCKit-${VERSION}-" | grep -v "MobileVLCKit" | grep -v "TVVLCKit" | wc -l | tr -d ' ' || true)
            TVOS_EXISTS=$(echo "$DIR_LISTING" | grep -c "TVVLCKit-${VERSION}-" || true)

            if [ "$IOS_EXISTS" -gt 0 ] && [ "$MACOS_EXISTS" -gt 0 ] && [ "$TVOS_EXISTS" -gt 0 ]; then
              echo "‚úÖ New version found with binaries: ${VERSION}"
              NEW_VERSIONS="${NEW_VERSIONS} ${VERSION}"
            else
              echo "‚è≠Ô∏è  Version ${VERSION} exists but binaries not yet available (iOS=${IOS_EXISTS} macOS=${MACOS_EXISTS} tvOS=${TVOS_EXISTS})"
            fi
          done

          if [ -z "$NEW_VERSIONS" ]; then
            echo ""
            echo "üò¥ No new versions to release."
            exit 0
          fi

          echo ""
          echo "üöÄ Creating tags for new versions:${NEW_VERSIONS}"
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Setup auth using PAT if available, fallback to GITHUB_TOKEN
          if [ -n "${{ secrets.PAT_TOKEN }}" ]; then
            echo "üîë Using PAT_TOKEN for git push"
            git remote set-url origin "https://${{ secrets.PAT_TOKEN }}@github.com/${{ github.repository }}.git"
          else
            echo "‚ö†Ô∏è PAT_TOKEN not found! Falling back to GITHUB_TOKEN. Tag pushes won't trigger the release workflow."
            # GITHUB_TOKEN is already configured by actions/checkout
          fi

          for VERSION in $NEW_VERSIONS; do
            echo "üè∑Ô∏è  Tagging ${VERSION}..."
            git tag "$VERSION"
            git push origin "$VERSION"
            echo "   ‚úÖ Tag ${VERSION} pushed."
            # Small delay to avoid race conditions between workflow triggers
            sleep 5
          done
